#!/bin/bash
## begin license ##
#
# The Meresco Virtuoso package is an Virtuoso Triplestore based on meresco-triplestore
#
# Copyright (C) 2014 Seecr (Seek You Too B.V.) http://seecr.nl
#
# This file is part of "Meresco Virtuoso"
#
# "Meresco Virtuoso" is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# "Meresco Virtuoso" is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with "Meresco Virtuoso"; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
#
## end license ##



ODBC_PORT=1111
HTTP_PORT=8890
while getopts ":o:h:s:" opt; do
    case $opt in
        o) ODBC_PORT="$OPTARG";;
        h) HTTP_PORT="$OPTARG";;
        s) STATEDIR="$OPTARG";;
        \?) ... ;;
        :) echo "option requires an argument -- $OPTARG" >&2 ;;
    esac
done

if [ -z "$STATEDIR" ]; then
    echo "Usage: $0 -s <state directory> [ -o ODBC_PORT ] [ -h HTTP_PORT ]"
    exit 1
fi
mkdir -p $STATEDIR/db
STATEDIR=$(cd $STATEDIR; pwd)
INI_FILE=$STATEDIR/meresco-virtuoso.ini
defaultIniFile=/etc/virtuoso/virtuoso.ini
test -f $defaultIniFile || defaultIniFile=/var/lib/virtuoso/db/virtuoso.ini

cp $defaultIniFile $INI_FILE

sed -i $INI_FILE -re "
        s,/var/lib/virtuoso/db,${STATEDIR}/db,g;
        /\[Parameters\]/,+4 s/^ServerPort.*/ServerPort = ${ODBC_PORT}/;
        /\[HTTPServer\]/,+4 s/^ServerPort.*/ServerPort = ${HTTP_PORT}/;
    "

exec virtuoso-t +configfile $INI_FILE +foreground
